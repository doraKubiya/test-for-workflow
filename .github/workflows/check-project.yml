name: Check Project v2

on:
  schedule:
    - cron: "*/5 * * * *"
  workflow_dispatch:

jobs:
  check-status:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create query.json
        run: |
          echo '{"query": "query { user(login:\"doraKubiya\") { projectV2(number:2) { items(first:20) { nodes { id content { ... on Issue { number title } } fieldValues(first:10) { nodes { ... on ProjectV2ItemFieldSingleSelectValue { name field { ... on ProjectV2FieldCommon { name } } } } } } } } } }"}' > query.json
          ls -la

      - name: Call GraphQL API
        run: |
          curl -H "Authorization: bearer ${{ secrets.PROJECT_TOKEN }}" \
               -X POST \
               -H "Content-Type: application/json" \
               --data-binary @query.json \
               https://api.github.com/graphql > result.json
          cat result.json

      - name: Find issues with In Progress
        id: parse
        run: |
          ISSUES=$(jq -r '.data.user.projectV2.items.nodes[]
            | select(.fieldValues.nodes[].name?=="In Progress")
            | .content.number' result.json)

          echo " Found Issues:"
          echo "$ISSUES"

          # 砖专 转 专砖
          echo "$ISSUES" > issues.txt

      - name: Comment on each issue
        if: always()
        run: |
          while read issue; do
            if [ -n "$issue" ]; then
              echo " 住祝 转 -#$issue"
              gh api repos/${{ github.repository }}/issues/$issue/comments \
                -f body='专  In Progress ' \
                -H "Authorization: token ${{ secrets.PROJECT_TOKEN }}"
            fi
          done < issues.txt
        env:
          GITHUB_TOKEN: ${{ secrets.PROJECT_TOKEN }}
